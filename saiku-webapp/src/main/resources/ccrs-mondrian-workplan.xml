<Schema name="IMS" metamodelVersion="4.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="mondrian.xsd">
    <Annotations>
        <Annotation name="desc">Cube Schema for CCRS - Workplan</Annotation>
    </Annotations>

    <PhysicalSchema>
        <Query alias="BASE_COUNTRY">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[select ISO2, REGION, NAME from BASE_COUNTRY, CATEGORY where BASE_COUNTRY.ISO2 = CATEGORY.COUNTRY AND DTYPE = 'CountryRegion' and REGION <> 'Uncategorized']]>
                </SQL>
            </ExpressionView>
        </Query>

        <Query alias="Agency">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[SELECT ID, LABEL FROM CATEGORY WHERE DTYPE='Agency']]>
                </SQL>
            </ExpressionView>
        </Query>

        <Query alias="BudgetType">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[SELECT ID, LABEL FROM CATEGORY WHERE DTYPE='BudgetType']]>
                </SQL>
            </ExpressionView>
        </Query>


        <Query alias="WorkstreamSection">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[SELECT ID, LABEL FROM CATEGORY WHERE DTYPE='WorkstreamSection']]>
                </SQL>
            </ExpressionView>
        </Query>

        <Query alias="WorkplanCube">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[
                    SELECT
                        WORKPLAN.ID as WORKPLAN_ID,
                        WORKPLAN.DESIGNATION as WORKPLAN_DESIGNATION,
                        WORKPLAN.ENTITY_YEAR as WORKPLAN_ENTITY_YEAR,
                        WORKPLAN.WORKFLOW as WORKPLAN_WORKFLOW,
                        WORKSTREAM.ID as WORKSTREAM_ID,
                        WORKSTREAM.SECTION_ID WORKSTREAM_SECTION_ID,
                        OUTPUTS.ID as OUTPUTS_ID,
                        OUTPUTS.LEAD_UNIT_ID as OUTPUTS_LEAD_UNIT_ID,
                        AGENCY_ROLES.LEAD_AGENCY_ID as AGENCY_ROLES_LEAD_AGENCY_ID,
                        AGENCY_ROLES.ROLE_OF_PARTNERS as AGENCY_ROLES_ROLE_OF_PARTNERS,
                        ACTIVITY.ID as ACTIVITY_ID,
                        ACTIVITY.LEAD_UNIT_ID as ACTIVITY_LEAD_UNIT_ID,
                        CASE WHEN ACTIVITY.SELECT_AS_GOOD_PRACTICE IS NULL THEN 'No' ELSE CASE WHEN ACTIVITY.SELECT_AS_GOOD_PRACTICE = FALSE THEN 'No' ELSE 'Yes' END END as ACTIVITY_SELECT_AS_GOOD_PRACTICE,
                        BUDGET.ID as BUDGET_ID,
                        BUDGET.TYPE_ID as BUDGET_TYPE_ID,
                        BUDGET.REQUIRED_AMOUNT as BUDGET_EXPECTED,
                        BUDGET.SPENT_AMOUNT as BUDGET_ACTUAL
                    FROM WORKPLAN workplan
                        LEFT OUTER JOIN WORKSTREAM workstream ON workstream.WORKPLAN_ID = workplan.ID
                        LEFT OUTER JOIN OUTPUTS outputs ON outputs.WORKSTREAM_ID = workstream.ID
                        LEFT OUTER JOIN AGENCY_ROLES agency_roles ON agency_roles.OUTPUT_ID = outputs.ID
                        LEFT OUTER JOIN ACTIVITY activity ON activity.OUTPUT_ID = outputs.ID
                        LEFT OUTER JOIN BUDGET budget ON budget.ACTIVITY_ID = activity.ID
                    WHERE
                        workplan.WORKFLOW = 'VALIDATED' AND
                        workplan.DESIGNATION != 'AQ' AND workplan.DESIGNATION != 'DOCO' AND workplan.DESIGNATION in (select iso2 from BASE_COUNTRY)
                    ]]>
                </SQL>
            </ExpressionView>
        </Query>
    </PhysicalSchema>

    <!--*************************************************************************
    ***** Workplan Cube
    *************************************************************************-->
    <Cube name="Workplan" caption="Workplan Analysis" visible="true" cache="true" enabled="true" defaultMeasure="Count">
        <Dimensions>
            <Dimension name="Country" caption="Country" table="BASE_COUNTRY"
                       key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ISO2"
                               hasHierarchy="false" levelType="Regular" datatype="Integer" />

                    <Attribute name="Country" caption="Country" keyColumn="NAME"
                               hierarchyAllMemberName="All Countries" hierarchyCaption="All Countries"
                               levelType="Regular" datatype="String" />
                </Attributes>
            </Dimension>

            <Dimension name="Region" caption="Region" table="BASE_COUNTRY"
                       key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ISO2"
                               hasHierarchy="false" levelType="Regular" datatype="Integer" />

                    <Attribute name="Region" caption="Region" keyColumn="REGION"
                               hierarchyAllMemberName="All Regions" hierarchyCaption="All Regions"
                               levelType="Regular" datatype="String" />
                </Attributes>
            </Dimension>

            <Dimension name="Year" caption="Year" table="WorkplanCube"
                       visible="true">
                <Attributes>
                    <Attribute name="Year" keyColumn="WORKPLAN_ENTITY_YEAR" datatype="Integer" />
                </Attributes>
            </Dimension>

            <Dimension name="WorkstreamSection" caption="Workstream Section" table="WorkstreamSection"
                       key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false" levelType="Regular" datatype="Integer" />

                    <Attribute name="WorkstreamSection" caption="Section name" keyColumn="LABEL"
                               levelType="Regular" datatype="String" />
                </Attributes>
            </Dimension>

            <Dimension name="Lead Agency" caption="Lead Agency" table='Agency' key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Lead Agency" caption="Lead Agency" keyColumn="LABEL"
                               hierarchyAllMemberName="All Lead Agencies" hierarchyCaption="All Lead Agencies"
                               levelType="Regular" datatype="String"/>
                </Attributes>
            </Dimension>

            <Dimension name="Role of partners" table='WorkplanCube' key="Dimension Id">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="AGENCY_ROLES_LEAD_AGENCY_ID"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Role of partners" caption="Role of partners" keyColumn="AGENCY_ROLES_ROLE_OF_PARTNERS"
                               hierarchyAllMemberName="All roles" hierarchyCaption="All roles"
                               levelType="Regular" datatype="String"/>
                </Attributes>
            </Dimension>

            <Dimension name="Is good practice?" table='WorkplanCube' key="Dimension Id">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ACTIVITY_ID"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Is good practice?" caption="Is good practice?" keyColumn="ACTIVITY_SELECT_AS_GOOD_PRACTICE"
                               hierarchyAllMemberName="All good practice" hierarchyCaption="All good practice"
                               levelType="Regular" datatype="Boolean"/>
                </Attributes>
            </Dimension>

            <Dimension name="Budget Type" caption="Budget Type" table='BudgetType' key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Budget Type" caption="Budget Type" keyColumn="LABEL"
                               hierarchyAllMemberName="All budget types" hierarchyCaption="All budget types"
                               levelType="Regular" datatype="String"/>
                </Attributes>
            </Dimension>

            <!--<Dimension name="Delivering as One" caption="Delivering as One" table='DAOCP3JointProgrammes' key="Dimension Id">-->
            <!--<Attributes>-->
            <!--<Attribute name="Dimension Id" keyColumn="id"-->
            <!--hasHierarchy="false"-->
            <!--levelType="Regular" datatype="Integer"/>-->

            <!--<Attribute name="Delivering as One" caption="Delivering as One" keyColumn="answer"-->
            <!--approxRowCount="2" hierarchyHasAll="true"-->
            <!--levelType="Regular" datatype="Boolean"/>-->
            <!--</Attributes>-->
            <!--</Dimension>-->

        </Dimensions>

        <MeasureGroups>
            <MeasureGroup name="Workplan Measures" table="WorkplanCube">
                <Measures>
                    <Measure name="Count" caption="Number of workplans" column="WORKPLAN_ID" datatype="Integer" aggregator="distinct-count" visible="true" formatString="#,###"/>
                    <Measure name="Expected Budget" caption="Expected Budget" column="BUDGET_EXPECTED" datatype="Numeric" aggregator="sum" visible="true" formatString="#,###"/>
                    <Measure name="Actual Budget" caption="Actual Budget" column="BUDGET_ACTUAL" datatype="Numeric" aggregator="sum" visible="true" formatString="#,###"/>
                </Measures>
                <DimensionLinks>
                    <FactLink dimension="Year" />
                    <FactLink dimension="Role of partners" />
                    <FactLink dimension="Is good practice?" />
                    <ForeignKeyLink dimension="Country" foreignKeyColumn="WORKPLAN_DESIGNATION"/>
                    <ForeignKeyLink dimension="Region" foreignKeyColumn="WORKPLAN_DESIGNATION"/>
                    <ForeignKeyLink dimension="WorkstreamSection" foreignKeyColumn="WORKSTREAM_SECTION_ID"/>
                    <ForeignKeyLink dimension="Lead Agency" foreignKeyColumn="AGENCY_ROLES_LEAD_AGENCY_ID"/>
                    <ForeignKeyLink dimension="Budget Type" foreignKeyColumn="BUDGET_TYPE_ID"/>
                    <!--<ForeignKeyLink dimension="Delivering as One"  foreignKeyColumn="OFFICIAL_REQUEST_DAO_COUNTRY"/>-->
                </DimensionLinks>
            </MeasureGroup>
        </MeasureGroups>

    </Cube>
</Schema>
