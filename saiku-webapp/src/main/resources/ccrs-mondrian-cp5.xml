<Schema name="Common Premises Profile" metamodelVersion="4.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="mondrian.xsd">
    <Annotations>
        <Annotation name="desc">Cube Schema for CCRS - Common Premises Profile</Annotation>
    </Annotations>

    <PhysicalSchema>
        <!-- ## _SHARED_PHYSICAL_SCHEMA_TAG_ ## -->
        
        <Query alias="CP5UNCTMembersSharedOffices">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[
                        select
                            M.ID, M.LOCATION,
                            COALESCE(COMMON_PREMISES_TYPE_ID.LABEL, 'X-CATEGORY') as COMMON_PREMISES_TYPE_ID,
                            CP1.DESIGNATION, CP1.ENTITY_YEAR,
                            COALESCE(COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as COUNTRY_INCOME_STATUS_ID,
                            COALESCE(SECONDARY_COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as SECONDARY_COUNTRY_INCOME_STATUS_ID,
                            COALESCE(cp1.OFFICIAL_REQUEST_DAO_COUNTRY, 'X-BOOLEAN') AS OFFICIAL_REQUEST_DAO_COUNTRY
                        FROM CP5SHARED_SUB_NATIONAL_OFFICES M
                            JOIN CP1GENERAL_PROFILE CP1 ON M.PARENT_ID = CP1.ID
                            JOIN BASE_COUNTRY bc ON CP1.DESIGNATION = bc.iso2
                            JOIN v_cp_validated_designations v ON CP1.designation = v.designation and v.entity_year = CP1.ENTITY_YEAR
                            JOIN CATEGORY COUNTRY_INCOME_STATUS_ID on CP1.COUNTRY_INCOME_STATUS_ID=COUNTRY_INCOME_STATUS_ID.ID
                            LEFT JOIN CATEGORY SECONDARY_COUNTRY_INCOME_STATUS_ID on CP1.SECONDARY_COUNTRY_INCOME_STATUS_ID=SECONDARY_COUNTRY_INCOME_STATUS_ID.ID
                            LEFT JOIN CATEGORY COMMON_PREMISES_TYPE_ID ON M.COMMON_PREMISES_TYPE_ID=COMMON_PREMISES_TYPE_ID.ID
                        WHERE CP1.DESIGNATION != 'AQ'
                          AND CP1.DESIGNATION != 'DOCO'
                    ]]>
                </SQL>
            </ExpressionView>
        </Query>

        <Query alias="CP5GeneralCube">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[
                        select
                            CP5.ID, CP5.DESIGNATION, CP5.ENTITY_YEAR,
                            COALESCE(COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as COUNTRY_INCOME_STATUS_ID,
                            COALESCE(SECONDARY_COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as SECONDARY_COUNTRY_INCOME_STATUS_ID,
                            COALESCE(cp5.HASUNCOMMON_PREMISES, 'X-BOOLEAN') AS HASUNCOMMON_PREMISES,
                            CASE WHEN cp5.HASUNCOMMON_PREMISES = TRUE THEN 1 ELSE 0 END as HASUNCOMMON_PREMISES_COUNT,
                            COALESCE(COMMON_PREMISES_TYPE_ID.LABEL, 'X-CATEGORY') as COMMON_PREMISES_TYPE_ID,
                            CASE WHEN cp5.HASUNCOMMON_PREMISES = TRUE THEN cp5uncommon.VALUE_OF_SAVINGS ELSE null END as VALUE_OF_SAVINGS,
                            COALESCE(cp5uncommon.HASUNCTSTRATEGY, 'X-BOOLEAN') AS HASUNCTSTRATEGY_DIM,
                            CASE WHEN cp5.HASUNCOMMON_PREMISES = FALSE THEN CASE WHEN cp5uncommon.HASUNCTSTRATEGY = TRUE THEN 1 ELSE 0 END ELSE 0 END as HASUNCTSTRATEGY_COUNT,
                            COALESCE(cp5.HAS_FEASIBILITY_STUDY, 'X-BOOLEAN') AS HAS_FEASIBILITY_STUDY,
                            CASE WHEN cp5.HAS_FEASIBILITY_STUDY = TRUE THEN 1 ELSE 0 END as HAS_FEASIBILITY_STUDY_COUNT,
                            CASE WHEN cp5.HAS_FEASIBILITY_STUDY = TRUE THEN CASE WHEN cp5study.TTCP_REVIEW_AND_FEEDBACK = TRUE THEN 1 ELSE 0 END ELSE 0 END as TTCP_REVIEW_AND_FEEDBACK_COUNT,
                            COALESCE(cp5study.TTCP_REVIEW_AND_FEEDBACK, 'X-BOOLEAN') AS TTCP_REVIEW_AND_FEEDBACK_DIM,
                            COALESCE(cp5.HAS_SHARED_SUB_NATIONAL_OFFICES, 'X-BOOLEAN') AS HAS_SHARED_SUB_NATIONAL_OFFICES_DIM,
                            CASE WHEN cp5.HAS_SHARED_SUB_NATIONAL_OFFICES = TRUE THEN 1 ELSE 0 END as HAS_SHARED_SUB_NATIONAL_OFFICES_COUNT,
                            COALESCE(cp1.OFFICIAL_REQUEST_DAO_COUNTRY, 'X-BOOLEAN') AS OFFICIAL_REQUEST_DAO_COUNTRY,
                            COALESCE(shared_offices_id.LABEL, 'X-CATEGORY') as shared_offices_id
                        from CP5COMMON_PREMISES_PROFILE CP5
                             join CP1GENERAL_PROFILE CP1 on CP5.DESIGNATION = CP1.DESIGNATION AND CP5.ENTITY_YEAR = CP1.ENTITY_YEAR
                             left join CP5UNCOMMON_PREMISES cp5uncommon on cp5uncommon.PARENT_ID = cp5.id
                             left join CP5COMMON_PREMISES_FEASIBILITY_STUDY cp5study on cp5study.PARENT_ID = cp5.id
                             join BASE_COUNTRY bc on CP1.DESIGNATION = bc.iso2
                             join v_cp_validated_designations v on CP1.designation = v.designation and v.entity_year = CP1.ENTITY_YEAR
                             JOIN CATEGORY COUNTRY_INCOME_STATUS_ID on CP1.COUNTRY_INCOME_STATUS_ID=COUNTRY_INCOME_STATUS_ID.ID
                             LEFT JOIN CATEGORY SECONDARY_COUNTRY_INCOME_STATUS_ID on CP1.SECONDARY_COUNTRY_INCOME_STATUS_ID=SECONDARY_COUNTRY_INCOME_STATUS_ID.ID
                             LEFT JOIN CATEGORY COMMON_PREMISES_TYPE_ID ON cp5uncommon.COMMON_PREMISES_TYPE_ID=COMMON_PREMISES_TYPE_ID.ID
                             LEFT JOIN CATEGORY shared_offices_id ON cp5.shared_offices_id=shared_offices_id.ID
                        WHERE CP1.DESIGNATION != 'AQ' AND CP1.DESIGNATION != 'DOCO'
                    ]]>
                </SQL>
            </ExpressionView>
        </Query>
    </PhysicalSchema>
    
    <!--*************************************************************************
    ***** Shared Dimensions
    *************************************************************************-->
    <!-- ## _SHARED_DIMENSIONS_TAG_ ## -->

    <!--*************************************************************************
    ***** CP5 UNCT Members Shared Offices
    *************************************************************************-->
    <Cube name="UNCTMembersSharedOffices" caption="UNCT Members Shared Offices" visible="true"
          cache="true" enabled="true" defaultMeasure="Count">
        <Dimensions>
            <Dimension source="Region" />
            <Dimension source="Country" />
            <Dimension source="YesNoTable" table="CP5UNCTMembersSharedOffices" name="OFFICIAL_REQUEST_DAO_COUNTRY" caption="Delivering as One" />
            <Dimension name="Year" caption="Year" table="CP5UNCTMembersSharedOffices" visible="true">
                <Attributes>
                    <Attribute name="Year" keyColumn="ENTITY_YEAR" datatype="Integer" />
                </Attributes>
            </Dimension>
            <Dimension source="CATEGORY" table="CP5UNCTMembersSharedOffices" name="COUNTRY_INCOME_STATUS_ID" caption="Country Income Status" />
            <Dimension source="CATEGORY" table="CP5UNCTMembersSharedOffices" name="SECONDARY_COUNTRY_INCOME_STATUS_ID" caption="Secondary Country Income Status" />

            <Dimension name="Location" caption="Location" table="CP5UNCTMembersSharedOffices"
                       key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false" levelType="Regular" datatype="Integer" />

                    <Attribute name="Location" caption="Location" keyColumn="LOCATION"
                               hierarchyAllMemberName="All Locations" hierarchyCaption="All Locations"
                               levelType="Regular" datatype="String" />
                </Attributes>
            </Dimension>
            
            <Dimension source="CATEGORY" table="CP5UNCTMembersSharedOffices" name="COMMON_PREMISES_TYPE_ID" caption="Type of the Office." />
        </Dimensions>

        <MeasureGroups>
            <MeasureGroup name="CP5 UNCT Members Shared Offices Measures" table="CP5UNCTMembersSharedOffices">
                <Measures>
                    <Measure name="Count" caption="Number of UNCT Members with Shared Offices" column="ID" datatype="Integer"
                             aggregator="distinct-count" visible="true" formatString="#,###"/>
                </Measures>
                <DimensionLinks>
                    <!-- ## _SHARED_DIMENSIONS_LINKS_TAG_ ## -->
                    <FactLink dimension="OFFICIAL_REQUEST_DAO_COUNTRY" />
                    <FactLink dimension="COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="SECONDARY_COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="Location" />
                    <FactLink dimension="COMMON_PREMISES_TYPE_ID" />
                </DimensionLinks>
            </MeasureGroup>
        </MeasureGroups>
    </Cube>

    <!--*************************************************************************
    ***** CP5 General Cube
    *************************************************************************-->
    <Cube name="Common Premises Profile" caption="Common Premises Profile" visible="true"
          cache="true" enabled="true" defaultMeasure="Count">
        <Dimensions>
            <Dimension source="Region" />
            <Dimension source="Country" />
            <Dimension source="YesNoTable" table="CP5GeneralCube" name="OFFICIAL_REQUEST_DAO_COUNTRY" caption="Delivering as One" />
            <Dimension name="Year" caption="Year" table="CP5GeneralCube" visible="true">
                <Attributes>
                    <Attribute name="Year" keyColumn="ENTITY_YEAR" datatype="Integer" />
                </Attributes>
            </Dimension>
            <Dimension source="CATEGORY" table="CP5GeneralCube" name="COUNTRY_INCOME_STATUS_ID" caption="Country Income Status" />
            <Dimension source="CATEGORY" table="CP5GeneralCube" name="SECONDARY_COUNTRY_INCOME_STATUS_ID" caption="Secondary Country Income Status" />

            <Dimension source="YesNoTable" table="CP5GeneralCube" name="HASUNCOMMON_PREMISES" caption="Does the UNCT have UN Common Premises or UN House?" />
            <Dimension source="CATEGORY" table="CP5GeneralCube" name="COMMON_PREMISES_TYPE_ID" caption="Are the premises government-provided, rented or owned?" />
            <Dimension source="YesNoTable" table="CP5GeneralCube" name="HASUNCTSTRATEGY_DIM" caption="Does the UNCT have a strategy to support the establishment of common premises?" />
            <Dimension source="YesNoTable" table="CP5GeneralCube" name="HAS_FEASIBILITY_STUDY" caption="Has the UNCT ever developed a feasibility study for the implementation of common premises?" />
            <Dimension source="YesNoTable" table="CP5GeneralCube" name="TTCP_REVIEW_AND_FEEDBACK_DIM" caption="Did the UNDG Task Team on Common Premises (TTCP) review and provide feedback on the feasibility study?" />
            <Dimension source="YesNoTable" table="CP5GeneralCube" name="HAS_SHARED_SUB_NATIONAL_OFFICES_DIM" caption="Do UNCT members have any offices at the sub-national level?" />
            <Dimension source="CATEGORY" table="CP5GeneralCube" name="shared_offices_id" caption="How many offices are in shared premises with other entities?" />
        </Dimensions>

        <MeasureGroups>
            <MeasureGroup name="CP5 General Cube Measures" table="CP5GeneralCube">
                <Measures>
                    <Measure name="Count" caption="Number of Country Records Submitted" column="ID" datatype="Integer"
                             aggregator="distinct-count" visible="true" formatString="#,###"/>

                    <Measure name="hasUNCommonPremises" caption="Count of 'Does the UNCT have UN Common Premises or UN House?'" column="HASUNCOMMON_PREMISES_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="valueOfSavings" caption="What is the approximate USD value of the savings" column="VALUE_OF_SAVINGS"
                             datatype="Numeric" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasUNCTStrategy" caption="Count of 'Does the UNCT have a strategy to support the establishment of common premises?'" column="HASUNCTSTRATEGY_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasFeasibilityStudy" caption="Count of 'Has the UNCT ever developed a feasibility study for the implementation of common premises?'" column="HAS_FEASIBILITY_STUDY_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="ttcpReviewAndFeedback" caption="Count of 'Did the UNDG Task Team on Common Premises (TTCP) review and provide feedback on the feasibility study?'" column="TTCP_REVIEW_AND_FEEDBACK_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasSharedSubNationalOffices" caption="Count of 'Do UNCT members have any offices at the sub-national level?'" column="HAS_SHARED_SUB_NATIONAL_OFFICES_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>
                </Measures>
                <DimensionLinks>
                    <!-- ## _SHARED_DIMENSIONS_LINKS_TAG_ ## -->
                    <FactLink dimension="OFFICIAL_REQUEST_DAO_COUNTRY" />
                    <FactLink dimension="COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="SECONDARY_COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="COMMON_PREMISES_TYPE_ID" />
                    <FactLink dimension="HASUNCOMMON_PREMISES" />
                    <FactLink dimension="HAS_FEASIBILITY_STUDY" />
                    <FactLink dimension="TTCP_REVIEW_AND_FEEDBACK_DIM" />
                    <FactLink dimension="HAS_SHARED_SUB_NATIONAL_OFFICES_DIM" />
                    <FactLink dimension="HASUNCTSTRATEGY_DIM" />
                    <FactLink dimension="shared_offices_id" />
                </DimensionLinks>
            </MeasureGroup>
        </MeasureGroups>
    </Cube>
</Schema>