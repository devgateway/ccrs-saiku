<Schema name="Delivering as One Profile" metamodelVersion="4.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="mondrian.xsd">
    <Annotations>
        <Annotation name="desc">Cube Schema for CCRS - Delivering as One Profile</Annotation>
    </Annotations>

    <PhysicalSchema>
        <!-- ## _SHARED_PHYSICAL_SCHEMA_TAG_ ## -->
        
        <!-- ## _CATEGORY_QUERIES_TAG_ ## -->
        
        <!-- ## _YESNOTABLE_QUERIES_TAG_ ## -->

        <Query alias="CP10GeneralCube">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[
                        select
                            cp10.ID, cp10.DESIGNATION, cp10.ENTITY_YEAR, CP1.COUNTRY_INCOME_STATUS_ID, CP1.SECONDARY_COUNTRY_INCOME_STATUS_ID,
                            CASE WHEN cp10.HAS_AGREEDUNCTTOR = TRUE THEN 1 ELSE 0 END as HAS_AGREEDUNCTTOR_COUNT,
                            CASE WHEN cp10.HAS_AGREEDUNCTTOR = TRUE THEN 1 ELSE CASE WHEN cp10.HAS_AGREEDUNCTTOR = FALSE THEN 0 ELSE -1 END END as HAS_AGREEDUNCTTOR,
                            CASE WHEN cp10.HAS_AGREED_CONFLICT_RESOLUTION = TRUE THEN 1 ELSE 0 END as HAS_AGREED_CONFLICT_RESOLUTION_COUNT,
                            CASE WHEN cp10.HAS_AGREED_CONFLICT_RESOLUTION = TRUE THEN 1 ELSE CASE WHEN cp10.HAS_AGREED_CONFLICT_RESOLUTION = FALSE THEN 0 ELSE -1 END END as HAS_AGREED_CONFLICT_RESOLUTION,
                            CASE WHEN cp1.OFFICIAL_REQUEST_DAO_COUNTRY = TRUE THEN 1 ELSE CASE WHEN cp1.OFFICIAL_REQUEST_DAO_COUNTRY = FALSE THEN 0 ELSE -1 END END as OFFICIAL_REQUEST_DAO_COUNTRY
                        from CP10DELIVERING_AS_ONE_PROFILE cp10, CP1GENERAL_PROFILE cp1, BASE_COUNTRY bc, v_cp_validated_designations v
                        WHERE
                            cp10.DESIGNATION = cp1.DESIGNATION AND cp10.ENTITY_YEAR = cp1.ENTITY_YEAR AND
                            cp10.DESIGNATION != 'AQ' AND cp10.DESIGNATION != 'DOCO' AND cp10.DESIGNATION = bc.iso2 and
                            cp10.designation = v.designation and v.entity_year = cp10.ENTITY_YEAR
                    ]]>
                </SQL>
            </ExpressionView>
        </Query>
    </PhysicalSchema>

    <!--*************************************************************************
    ***** Shared Dimensions
    *************************************************************************-->
    <!-- ## _SHARED_DIMENSIONS_TAG_ ## -->
    
    <!--*************************************************************************
    ***** CP10 General Cube
    *************************************************************************-->
    <Cube name="One Profile" caption="Delivering as One Profile" visible="true"
          cache="true" enabled="true" defaultMeasure="Count">
        <Dimensions>
            <Dimension source="Region" />
            <Dimension source="Country" />
            <Dimension source="Delivering as One" />
            <Dimension name="Year" caption="Year" table="CP10GeneralCube" visible="true">
                <Attributes>
                    <Attribute name="Year" keyColumn="ENTITY_YEAR" datatype="Integer" />
                </Attributes>
            </Dimension>
            <Dimension source="CountryIncomeStatus" />
            <Dimension source="SecondaryCountryIncomeStatus" />
                        
            <Dimension table="YesNoTable" name="UNCT ToR" caption="Is there an agreed upon UNCT TOR?" />
            <Dimension table="YesNoTable" name="Conflict Resolution Mechanism" caption="Is there an agreed Conflict Resolution Mechanism?" />
        </Dimensions>

        <MeasureGroups>
            <MeasureGroup name="CP10 General Cube Measures" table="CP10GeneralCube">
                <Measures>
                    <Measure name="Count" caption="Number of Country Records Submitted" column="ID" datatype="Integer"
                             aggregator="distinct-count" visible="true" formatString="#,###"/>

                    <Measure name="UNCTToR" caption="Count of agreed upon UNCT ToR" column="HAS_AGREEDUNCTTOR_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="ConflictResolutionMechanism" caption="Count of agreed Conflict Resolution Mechanism" column="HAS_AGREED_CONFLICT_RESOLUTION_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>
                </Measures>
                <DimensionLinks>
                    <!-- ## _SHARED_DIMENSIONS_LINKS_TAG_ ## -->
                    <ForeignKeyLink dimension="UNCT ToR" foreignKeyColumn="HAS_AGREEDUNCTTOR"/>
                    <ForeignKeyLink dimension="Conflict Resolution Mechanism" foreignKeyColumn="HAS_AGREED_CONFLICT_RESOLUTION"/>
                </DimensionLinks>
            </MeasureGroup>
        </MeasureGroups>
    </Cube>
</Schema>