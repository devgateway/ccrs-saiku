<Schema name="Coordination Capacity" metamodelVersion="4.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="mondrian.xsd">
    <Annotations>
        <Annotation name="desc">Cube Schema for CCRS - Coordination Capacity</Annotation>
    </Annotations>

    <Role name="ROLE_VIEWER">
        <SchemaGrant access="none" />
    </Role>

    <Role name="ROLE_EDITOR">
        <SchemaGrant access="all" />
    </Role>

    <PhysicalSchema>
        <!-- ## _SHARED_PHYSICAL_SCHEMA_TAG_ ## -->
        
        <Query alias="CP2RcoStaffMemberDetail">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[
                        select
                            D.ID, D.ANNUAL_SALARY_AMOUNT,
                            COALESCE(OFFICE_TYPE_ID.LABEL, 'X-CATEGORY') as OFFICE_TYPE_ID,
                            COALESCE(CONTRACT_MODALITY_ID.LABEL, 'X-CATEGORY') as CONTRACT_MODALITY_ID,
                            COALESCE(STAFF_MEMBER_TITLE_ID.LABEL, 'X-CATEGORY') as STAFF_MEMBER_TITLE_ID,
                            COALESCE(LEVEL_ID.LABEL, 'X-CATEGORY') as LEVEL_ID,
                            COALESCE(FUNDING_ORGANIZATION_ID.LABEL, 'X-CATEGORY') as FUNDING_ORGANIZATION_ID,
                            COALESCE(WHICH_AGENCY_ID.LABEL, 'X-CATEGORY') as WHICH_AGENCY_ID,
                            D.HEADRCO,
                            CP2.DESIGNATION, CP2.ENTITY_YEAR,
                            COALESCE(COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as COUNTRY_INCOME_STATUS_ID,
                            COALESCE(SECONDARY_COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as SECONDARY_COUNTRY_INCOME_STATUS_ID,
                            date(d.start_date) as START_DATE_DATE,
                            date(d.end_date) as END_DATE_DATE,
                            COALESCE(D.HEADRCO, 'X-BOOLEAN') AS HEAD_OF_RCO,
                            CASE WHEN D.COMMUNICATION_SPECIALIST = TRUE THEN 1 ELSE 0 END as COMMUNICATION_SPECIALIST_COUNT,
                            COALESCE(D.COMMUNICATION_SPECIALIST, 'X-BOOLEAN') AS COMMUNICATION_SPECIALIST,
                            COALESCE(cp1.OFFICIAL_REQUEST_DAO_COUNTRY, 'X-BOOLEAN') AS OFFICIAL_REQUEST_DAO_COUNTRY,
                            COALESCE(gender_id.LABEL, 'X-CATEGORY') as gender_id,
                            COALESCE(D.nationality_id, -1) AS nationality_id
                        FROM CP2RCO_STAFF_MEMBER_DETAIL D
                            JOIN CP2COORDINATION_CAPACITY CP2 ON CP2.ID = D.PARENT_ID
                            JOIN CP1GENERAL_PROFILE CP1 ON CP2.DESIGNATION = CP1.DESIGNATION AND CP2.ENTITY_YEAR = CP1.ENTITY_YEAR
                            JOIN BASE_COUNTRY bc ON CP2.DESIGNATION = bc.ISO2
                            JOIN V_CP_VALIDATED_DESIGNATIONS v ON CP2.DESIGNATION = v.DESIGNATION AND v.ENTITY_YEAR = CP2.ENTITY_YEAR
                            JOIN CATEGORY COUNTRY_INCOME_STATUS_ID on CP1.COUNTRY_INCOME_STATUS_ID=COUNTRY_INCOME_STATUS_ID.ID
                            LEFT JOIN CATEGORY SECONDARY_COUNTRY_INCOME_STATUS_ID on CP1.SECONDARY_COUNTRY_INCOME_STATUS_ID=SECONDARY_COUNTRY_INCOME_STATUS_ID.ID
                            LEFT JOIN CATEGORY OFFICE_TYPE_ID ON D.OFFICE_TYPE_ID=OFFICE_TYPE_ID.ID
                            LEFT JOIN CATEGORY CONTRACT_MODALITY_ID ON D.CONTRACT_MODALITY_ID=CONTRACT_MODALITY_ID.ID
                            LEFT JOIN CATEGORY STAFF_MEMBER_TITLE_ID ON D.STAFF_MEMBER_TITLE_ID=STAFF_MEMBER_TITLE_ID.ID
                            LEFT JOIN CATEGORY LEVEL_ID ON D.LEVEL_ID=LEVEL_ID.ID
                            LEFT JOIN CATEGORY FUNDING_ORGANIZATION_ID ON D.FUNDING_ORGANIZATION_ID=FUNDING_ORGANIZATION_ID.ID
                            LEFT JOIN CATEGORY WHICH_AGENCY_ID ON D.WHICH_AGENCY_ID=WHICH_AGENCY_ID.ID
                            LEFT JOIN CATEGORY gender_id ON D.gender_id=gender_id.ID
                        WHERE CP2.DESIGNATION != 'AQ'
                          AND CP2.DESIGNATION != 'DOCO'
                    ]]>
                </SQL>
            </ExpressionView>
        </Query>

        <Query alias="CP2GeneralCube">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[
                        select
                            cp2.ID, cp2.DESIGNATION, cp2.ENTITY_YEAR,
                            COALESCE(COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as COUNTRY_INCOME_STATUS_ID,
                            COALESCE(SECONDARY_COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as SECONDARY_COUNTRY_INCOME_STATUS_ID,
                            CASE WHEN cp2.SUBNATIONAL_OFFICES = TRUE THEN 1 ELSE 0 END as SUBNATIONAL_OFFICES_COUNT,
                            COALESCE(cp2.SUBNATIONAL_OFFICES, 'X-BOOLEAN') AS SUBNATIONAL_OFFICES,
                            cp2.NUMBER_OF_OFFICES,
                            (select count(*) from CP2RCO_STAFF_MEMBER_DETAIL where PARENT_ID = cp2.id) STAFF_MEMEBER_COUNT,
                            COALESCE(cp1.OFFICIAL_REQUEST_DAO_COUNTRY, 'X-BOOLEAN') AS OFFICIAL_REQUEST_DAO_COUNTRY,
                            CASE WHEN cp2.rco_covers_multiple_countries = TRUE THEN 1 ELSE 0 END as rco_covers_multiple_countries_count,
                            COALESCE(cp2.rco_covers_multiple_countries, 'X-BOOLEAN') AS rco_covers_multiple_countries_dim
                        from CP2COORDINATION_CAPACITY cp2
                            JOIN CP1GENERAL_PROFILE cp1 ON cp2.DESIGNATION = cp1.DESIGNATION AND cp2.ENTITY_YEAR = cp1.ENTITY_YEAR
                            JOIN BASE_COUNTRY bc ON cp2.DESIGNATION = bc.ISO2
                            JOIN V_CP_VALIDATED_DESIGNATIONS v ON cp2.DESIGNATION = v.DESIGNATION AND v.ENTITY_YEAR = cp2.ENTITY_YEAR
                            JOIN CATEGORY COUNTRY_INCOME_STATUS_ID on CP1.COUNTRY_INCOME_STATUS_ID=COUNTRY_INCOME_STATUS_ID.ID
                            LEFT JOIN CATEGORY SECONDARY_COUNTRY_INCOME_STATUS_ID on CP1.SECONDARY_COUNTRY_INCOME_STATUS_ID=SECONDARY_COUNTRY_INCOME_STATUS_ID.ID
                        WHERE cp2.DESIGNATION != 'AQ'
                          AND cp2.DESIGNATION != 'DOCO'
                    ]]>
                </SQL>
            </ExpressionView>
        </Query>
    </PhysicalSchema>
    
    <!--*************************************************************************
    ***** Shared Dimensions
    *************************************************************************-->
    <!-- ## _SHARED_DIMENSIONS_TAG_ ## -->

    <!--*************************************************************************
    ***** CP2 RCO Staff Member Details
    *************************************************************************-->
    <Cube name="RCO Staff Member" caption="RCO Staff Member" visible="true" cache="true" enabled="true" defaultMeasure="Count">
        <Dimensions>
            <Dimension source="Region" />
            <Dimension source="Country" />
            <Dimension source="YesNoTable" table="CP2RcoStaffMemberDetail" name="OFFICIAL_REQUEST_DAO_COUNTRY" caption="Delivering as One" />
            <Dimension name="Year" caption="Year" table="CP2RcoStaffMemberDetail" visible="true">
                <Attributes>
                    <Attribute name="Year" keyColumn="ENTITY_YEAR" datatype="Integer" />
                </Attributes>
            </Dimension>
            <Dimension source="CATEGORY" table="CP2RcoStaffMemberDetail" name="COUNTRY_INCOME_STATUS_ID" caption="Country Income Status" />
            <Dimension source="CATEGORY" table="CP2RcoStaffMemberDetail" name="SECONDARY_COUNTRY_INCOME_STATUS_ID" caption="Secondary Country Income Status" />

            <Dimension source="CATEGORY" table="CP2RcoStaffMemberDetail" name="STAFF_MEMBER_TITLE_ID" caption="Staff Member Title" />
            <Dimension source="YesNoTable" table="CP2RcoStaffMemberDetail" name="HEAD_OF_RCO" caption="Head of RCO or Main RCO Contact." />
            <Dimension source="CATEGORY" table="CP2RcoStaffMemberDetail" name="OFFICE_TYPE_ID" caption="Office Type" />
            <Dimension source="CATEGORY" table="CP2RcoStaffMemberDetail" name="CONTRACT_MODALITY_ID" caption="Contract Modality" />
            <Dimension source="CATEGORY" table="CP2RcoStaffMemberDetail" name="FUNDING_ORGANIZATION_ID" caption="Funding Organization" />
            <Dimension source="CATEGORY" table="CP2RcoStaffMemberDetail" name="LEVEL_ID" caption="Post Level" />
            <Dimension source="CATEGORY" table="CP2RcoStaffMemberDetail" name="WHICH_AGENCY_ID" caption="UN Agency" />

            <Dimension name="Start Date" caption="Contract Start Date" table="CP2RcoStaffMemberDetail" key="Dimension Id" type="TIME">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Start Date" caption="Contract Start Date" keyColumn="START_DATE_DATE"
                               hierarchyHasAll="true"
                               levelType="TimeYears" datatype="Date"/>
                </Attributes>
            </Dimension>

            <Dimension name="End Date" caption="Contract End Date" table="CP2RcoStaffMemberDetail" key="Dimension Id" type="TIME">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="End Date" caption="Contract End Date" keyColumn="END_DATE_DATE"
                               hierarchyHasAll="true"
                               levelType="TimeYears" datatype="Date"/>
                </Attributes>
            </Dimension>
            <Dimension source="YesNoTable" table="CP2RcoStaffMemberDetail" name="COMMUNICATION_SPECIALIST" caption="Are you the main focal point for communications?" />
            <Dimension source="CATEGORY" table="CP2RcoStaffMemberDetail" name="gender_id" caption="Gender" />
            <Dimension name="Nationality" caption="Nationality" table="BASE_COUNTRY_WITHOUT_REGION" key="Dimension Id">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false" datatype="Integer" />

                    <Attribute name="Country" caption="Country" keyColumn="NAME"
                               hierarchyAllMemberName="All Countries" hierarchyCaption="All Countries" />
                </Attributes>
            </Dimension>
        </Dimensions>

        <MeasureGroups>
            <MeasureGroup name="CP2 RCOStaffMemberDetails Measures" table="CP2RcoStaffMemberDetail">
                <Measures>
                    <Measure name="Count" caption="Number of RCO Staff Members" column="ID" datatype="Integer"
                             aggregator="distinct-count" visible="true" formatString="#,###"/>

                    <Measure name="TotalAnnualNetSalaryAmount" caption="Total Annual Net Salary Amount"
                             column="ANNUAL_SALARY_AMOUNT" datatype="Numeric" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="mainFocalPointForCommunications" caption="Are you the main focal point for communications?'" column="COMMUNICATION_SPECIALIST_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                </Measures>

                <DimensionLinks>
                    <!-- ## _SHARED_DIMENSIONS_LINKS_TAG_ ## -->
                    <FactLink dimension="OFFICIAL_REQUEST_DAO_COUNTRY" />
                    <FactLink dimension="COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="SECONDARY_COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="OFFICE_TYPE_ID" />
                    <FactLink dimension="CONTRACT_MODALITY_ID" />
                    <FactLink dimension="STAFF_MEMBER_TITLE_ID" />
                    <FactLink dimension="LEVEL_ID" />
                    <FactLink dimension="Start Date" />
                    <FactLink dimension="End Date" />
                    <FactLink dimension="FUNDING_ORGANIZATION_ID" />
                    <FactLink dimension="WHICH_AGENCY_ID" />
                    <FactLink dimension="HEAD_OF_RCO" />
                    <FactLink dimension="COMMUNICATION_SPECIALIST" />
                    <FactLink dimension="gender_id" />
                    <ForeignKeyLink dimension="Nationality" foreignKeyColumn="nationality_id"/>
                </DimensionLinks>
            </MeasureGroup>
        </MeasureGroups>
    </Cube>

    <!--*************************************************************************
    ***** CP2 General Cube
    *************************************************************************-->
    <Cube name="Coordination Capacity" caption="Coordination Capacity" visible="true"
          cache="true" enabled="true" defaultMeasure="Count">
        <Dimensions>
            <Dimension source="Region" />
            <Dimension source="Country" />
            <Dimension source="YesNoTable" table="CP2GeneralCube" name="OFFICIAL_REQUEST_DAO_COUNTRY" caption="Delivering as One" />
            <Dimension name="Year" caption="Year" table="CP2GeneralCube" visible="true">
                <Attributes>
                    <Attribute name="Year" keyColumn="ENTITY_YEAR" datatype="Integer" />
                </Attributes>
            </Dimension>
            <Dimension source="CATEGORY" table="CP2GeneralCube" name="COUNTRY_INCOME_STATUS_ID" caption="Country Income Status" />
            <Dimension source="CATEGORY" table="CP2GeneralCube" name="SECONDARY_COUNTRY_INCOME_STATUS_ID" caption="Secondary Country Income Status" />

            <Dimension source="YesNoTable" table="CP2GeneralCube" name="SUBNATIONAL_OFFICES" caption="Does the RCO have Subnational offices?" />
            <Dimension source="YesNoTable" table="CP2GeneralCube" name="rco_covers_multiple_countries_dim" caption="Does the RCO cover multiple countries?" />
        </Dimensions>

        <MeasureGroups>
            <MeasureGroup name="CP2 General Cube Measures" table="CP2GeneralCube">
                <Measures>
                    <Measure name="Count" caption="Number of Country Records Submitted" column="ID" datatype="Integer"
                             aggregator="distinct-count" visible="true" formatString="#,###"/>

                    <Measure name="subnationalOffices" caption="Count of 'Does the RCO have Subnational offices?'" column="SUBNATIONAL_OFFICES_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="howManyOffices" caption="Count of RCO Subnational offices" column="NUMBER_OF_OFFICES"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="countRCOStaffMember" caption="Count of RCO Staff Member" column="STAFF_MEMEBER_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="rcoCoversMultipleCountries" caption="Count of 'Does the RCO cover multiple countries?'" column="rco_covers_multiple_countries_count"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                </Measures>
                <DimensionLinks>
                    <!-- ## _SHARED_DIMENSIONS_LINKS_TAG_ ## -->
                    <FactLink dimension="OFFICIAL_REQUEST_DAO_COUNTRY" />
                    <FactLink dimension="COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="SECONDARY_COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="SUBNATIONAL_OFFICES"/>
                    <FactLink dimension="rco_covers_multiple_countries_dim"/>
                </DimensionLinks>
            </MeasureGroup>
        </MeasureGroups>
    </Cube>
</Schema>
