<Schema name="Joint Leadership and Management Profile" metamodelVersion="4.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="mondrian.xsd">
    <Annotations>
        <Annotation name="desc">Cube Schema for CCRS - Joint Leadership and Management Profile</Annotation>
    </Annotations>

    <PhysicalSchema>
        <Query alias="BASE_COUNTRY">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[select ISO2, REGION, NAME from BASE_COUNTRY, CATEGORY where BASE_COUNTRY.ISO2 = CATEGORY.COUNTRY AND DTYPE = 'CountryRegion' and REGION <> 'Uncategorized']]>
                </SQL>
            </ExpressionView>
        </Query>

        <Query alias="CountryIncomeStatus">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[SELECT ID, LABEL FROM CATEGORY WHERE DTYPE='CountryIncomeStatus']]>
                </SQL>
            </ExpressionView>
        </Query>

        <Query alias="SecondaryCountryIncomeStatus">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[SELECT ID, LABEL FROM CATEGORY WHERE DTYPE='SecondaryCountryIncomeStatus']]>
                </SQL>
            </ExpressionView>
        </Query>

        <Query alias="CP8GeneralCube">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[
                        select
                            cp8.ID, cp8.DESIGNATION, cp8.ENTITY_YEAR, CP1.COUNTRY_INCOME_STATUS_ID, CP1.SECONDARY_COUNTRY_INCOME_STATUS_ID,
                            CASE WHEN cp8.HASUNDPDEPUTY_REPRESENTATIVE = TRUE THEN 1 ELSE 0 END as HASUNDPDEPUTY_REPRESENTATIVE,
                            CASE WHEN cp8.HAS_CODE_OF_CONDUCT = TRUE THEN 1 ELSE 0 END as HAS_CODE_OF_CONDUCT,
                            CASE WHEN cp8.HAS_CODE_OF_CONDUCT = TRUE THEN date(cp8code.DATE_IMPLEMENTED) ELSE null END as DATE_IMPLEMENTED,
                            CASE WHEN cp8.HAS_COUNTRY_DIRECTOR = TRUE THEN 1 ELSE 0 END as HAS_COUNTRY_DIRECTOR,                            
                            CASE WHEN cp8.HAS_COUNTRY_DIRECTOR = TRUE THEN CASE WHEN cp8.SIGNED_DELEGATION_OF_AUTHORITY_LETTER = TRUE THEN 1 ELSE 0 END ELSE null END as SIGNED_DELEGATION_OF_AUTHORITY_LETTER,
                            CASE WHEN cp8.HASUNDPDEPUTY_REPRESENTATIVE = TRUE THEN CASE WHEN cp8.SIGNED_DELEGATION_AUTHORITY = TRUE THEN 1 ELSE 0 END ELSE null END as SIGNED_DELEGATION_AUTHORITY,
                            CASE WHEN cp1.OFFICIAL_REQUEST_DAO_COUNTRY = TRUE THEN 1 ELSE 0 END as OFFICIAL_REQUEST_DAO_COUNTRY
                        from CP8JOINT_LEADERSHIP_MANAGEMENT cp8, CP1GENERAL_PROFILE cp1, CP8CODE_OF_CONDUCT cp8code, BASE_COUNTRY bc, v_cp_validated_designations v
                        WHERE
                            cp8.DESIGNATION = cp1.DESIGNATION AND cp8.ENTITY_YEAR = cp1.ENTITY_YEAR AND
                            cp8code.PARENT_ID = cp8.ID AND
                            cp8.DESIGNATION != 'AQ' AND cp8.DESIGNATION != 'DOCO' AND cp8.DESIGNATION = bc.iso2 and
                            cp8.designation = v.designation and v.entity_year = cp8.ENTITY_YEAR
                    ]]>
                </SQL>
            </ExpressionView>
        </Query>
        <InlineTable alias="DAOCP8GeneralCube"><ColumnDefs><ColumnDef name="id" type="Numeric"/><ColumnDef name="answer" type="String"/></ColumnDefs><Key><Column name="id"/></Key><Rows><Row><Value column="id">0</Value><Value column="answer">No</Value></Row><Row><Value column="id">1</Value><Value column="answer">Yes</Value></Row></Rows></InlineTable>
        <InlineTable alias="HAS_CODE_OF_CONDUCT"><ColumnDefs><ColumnDef name="id" type="Numeric"/><ColumnDef name="answer" type="String"/></ColumnDefs><Key><Column name="id"/></Key><Rows><Row><Value column="id">0</Value><Value column="answer">No</Value></Row><Row><Value column="id">1</Value><Value column="answer">Yes</Value></Row></Rows></InlineTable>
        <InlineTable alias="HAS_COUNTRY_DIRECTOR"><ColumnDefs><ColumnDef name="id" type="Numeric"/><ColumnDef name="answer" type="String"/></ColumnDefs><Key><Column name="id"/></Key><Rows><Row><Value column="id">0</Value><Value column="answer">No</Value></Row><Row><Value column="id">1</Value><Value column="answer">Yes</Value></Row></Rows></InlineTable>
        <InlineTable alias="HAS_UNDPDEPUTY_REPRESENTATIVE"><ColumnDefs><ColumnDef name="id" type="Numeric"/><ColumnDef name="answer" type="String"/></ColumnDefs><Key><Column name="id"/></Key><Rows><Row><Value column="id">0</Value><Value column="answer">No</Value></Row><Row><Value column="id">1</Value><Value column="answer">Yes</Value></Row></Rows></InlineTable>       
        <InlineTable alias="SIGNED_DELEGATION_OF_AUTHORITY_LETTER"><ColumnDefs><ColumnDef name="id" type="Numeric"/><ColumnDef name="answer" type="String"/></ColumnDefs><Key><Column name="id"/></Key><Rows><Row><Value column="id">0</Value><Value column="answer">No</Value></Row><Row><Value column="id">1</Value><Value column="answer">Yes</Value></Row></Rows></InlineTable>
		<InlineTable alias="SIGNED_DELEGATION_AUTHORITY"><ColumnDefs><ColumnDef name="id" type="Numeric"/><ColumnDef name="answer" type="String"/></ColumnDefs><Key><Column name="id"/></Key><Rows><Row><Value column="id">0</Value><Value column="answer">No</Value></Row><Row><Value column="id">1</Value><Value column="answer">Yes</Value></Row></Rows></InlineTable>       
    </PhysicalSchema>

    <!--*************************************************************************
    ***** CP8 General Cube
    *************************************************************************-->
    <Cube name="CP8GeneralCube" caption="CP8 General Cube" visible="true"
          cache="true" enabled="true" defaultMeasure="Count">
        <Dimensions>
            <Dimension name="Region" caption="Region" table="BASE_COUNTRY"
                       key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ISO2"
                               hasHierarchy="false" levelType="Regular" datatype="Integer" />

                    <Attribute name="Region" caption="Region" keyColumn="REGION"
                               hierarchyAllMemberName="All Regions" hierarchyCaption="All Regions"
                               levelType="Regular" datatype="String" />
                </Attributes>
            </Dimension>

            <Dimension name="Country" caption="Country" table="BASE_COUNTRY"
                       key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ISO2"
                               hasHierarchy="false" levelType="Regular" datatype="Integer" />

                    <Attribute name="Country" caption="Country" keyColumn="NAME"
                               hierarchyAllMemberName="All Countries" hierarchyCaption="All Countries"
                               levelType="Regular" datatype="String" />
                </Attributes>
            </Dimension>

            <Dimension name="Delivering as One" caption="Delivering as One" table='DAOCP8GeneralCube' key="Dimension Id">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="id"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Delivering as One" caption="Delivering as One" keyColumn="answer"
                               approxRowCount="2" hierarchyHasAll="true"
                               levelType="Regular" datatype="Boolean"/>
                </Attributes>
            </Dimension>

            <Dimension name="Year" caption="Year" table="CP8GeneralCube"
                       visible="true">
                <Attributes>
                    <Attribute name="Year" keyColumn="ENTITY_YEAR" datatype="Integer" />
                </Attributes>
            </Dimension>

            <Dimension name="CountryIncomeStatus" caption="Country Income Status" table="CountryIncomeStatus"
                       key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false" levelType="Regular" datatype="Integer" />

                    <Attribute name="CountryIncomeStatus" caption="Country Income Status" keyColumn="LABEL"
                               hierarchyAllMemberName="All CountryIncomeStatus" hierarchyCaption="All Country Income Statuses"
                               levelType="Regular" datatype="String" />
                </Attributes>
            </Dimension>

            <Dimension name="SecondaryCountryIncomeStatus" caption="Secondary Country Income Status" table="SecondaryCountryIncomeStatus"
                       key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false" levelType="Regular" datatype="Integer" />

                    <Attribute name="SecondaryCountryIncomeStatus" caption="SecondaryCountry Income Status" keyColumn="LABEL"
                               hierarchyAllMemberName="All SecondaryCountryIncomeStatus" hierarchyCaption="All Secondary Country Income Statuses"
                               levelType="Regular" datatype="String" />
                </Attributes>
            </Dimension>

            <Dimension name="Does the UNCT have a code of conduct" caption="Does the UNCT have a code of conduct?" table='HAS_CODE_OF_CONDUCT' key="Dimension Id">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="id"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Does the UNCT have a code of conduct" caption="Does the UNCT have a code of conduct?" keyColumn="answer"
                               approxRowCount="2" hierarchyHasAll="true"
                               levelType="Regular" datatype="Boolean"/>
                </Attributes>
            </Dimension>

            <Dimension name="Date code of conduct was implemented" caption="Date code of conduct was implemented" table='CP8GeneralCube'
                       key="Dimension Id" type="TIME">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Date" caption="Date" keyColumn="DATE_IMPLEMENTED"
                               hierarchyHasAll="true"
                               levelType="TimeUndefined" datatype="Date"/>
                </Attributes>
            </Dimension>

            <Dimension name="Does the UNDP have a Country Director" caption="Does the UNDP have a Country Director?" table='HAS_COUNTRY_DIRECTOR' key="Dimension Id">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="id"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Does the UNDP have a Country Director" caption="Does the UNDP have a Country Director?" keyColumn="answer"
                               approxRowCount="2" hierarchyHasAll="true"
                               levelType="Regular" datatype="Boolean"/>
                </Attributes>
            </Dimension>

            <Dimension name="Is there a signed delegation of authority between the UNDP Resident Representative and the UNDP Country Director and/or UNDP Deputy Country Director?" table='SIGNED_DELEGATION_OF_AUTHORITY_LETTER' key="Dimension Id">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="id"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Is there a signed delegation of authority between the UNDP Resident Representative and the UNDP Country Director and/or UNDP Deputy Country Director?" caption="Is there a signed delegation of authority letter between the UNDP Resident Representative (RR) and UNDP Country Director including for resource mobilization?" keyColumn="answer"
                               approxRowCount="2" hierarchyHasAll="true"
                               levelType="Regular" datatype="Boolean"/>
                </Attributes>
            </Dimension>

            <Dimension name="Does UNDP have a Deputy Representative" caption="Does UNDP have a Deputy Representative?" table='HAS_UNDPDEPUTY_REPRESENTATIVE' key="Dimension Id">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="id"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Does UNDP have a Deputy Representative" caption="Does UNDP have a Deputy Representative?" keyColumn="answer"
                               approxRowCount="2" hierarchyHasAll="true"
                               levelType="Regular" datatype="Boolean"/>
                </Attributes>
            </Dimension>

            <Dimension name="Is there a signed delegation of authority letter" caption="Is there a signed delegation of authority letter between the UNDP Deputy Resident Representative (DR) and UNDP Country Director including for resource mobilization?" table='HAS_CODE_OF_CONDUCT' key="Dimension Id">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="id"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Is there a signed delegation of authority letter" caption="Is there a signed delegation of authority letter between the UNDP Deputy Resident Representative (DR) and UNDP Country Director including for resource mobilization?" keyColumn="answer"
                               approxRowCount="2" hierarchyHasAll="true"
                               levelType="Regular" datatype="Boolean"/>
                </Attributes>
            </Dimension>
        </Dimensions>

        <MeasureGroups>
            <MeasureGroup name="CP8 General Cube Measures" table="CP8GeneralCube">
                <Measures>
                    <Measure name="Count" caption="Number of Country Records Submitted" column="ID" datatype="Integer"
                             aggregator="distinct-count" visible="true" formatString="#,###"/>

                    <Measure name="hasCodeOfConduct" caption="Count of 'Does the UNCT have a code of conduct?'" column="HAS_CODE_OF_CONDUCT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasCountryDirector" caption="Count of 'Does the UNDP have a Country Director?'" column="HAS_COUNTRY_DIRECTOR"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="signedDelegationOfAuthorityLetter" caption="Count of 'Is there a signed delegation of authority between the UNDP Resident Representative and the UNDP Country Director and/or UNDP Deputy Country Director?'" column="SIGNED_DELEGATION_OF_AUTHORITY_LETTER"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasUNDPDeputyRepresentative" caption="Count of 'Does UNDP have a Deputy Representative?'" column="HASUNDPDEPUTY_REPRESENTATIVE"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>
                             
                    <Measure name="signedDelegationAuthority" caption="Count of 'Is there a signed delegation of authority letter between the UNDP Deputy Resident Representative (DR) and UNDP Country Director including for resource mobilization?'" column="SIGNED_DELEGATION_AUTHORITY"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>                             
                </Measures>
                <DimensionLinks>
                    <ForeignKeyLink dimension="Country" foreignKeyColumn="DESIGNATION"/>
                    <ForeignKeyLink dimension="Region" foreignKeyColumn="DESIGNATION"/>
                    <FactLink dimension="Year" />
                    <ForeignKeyLink dimension="CountryIncomeStatus" foreignKeyColumn="COUNTRY_INCOME_STATUS_ID" />
                    <ForeignKeyLink dimension="SecondaryCountryIncomeStatus" foreignKeyColumn="SECONDARY_COUNTRY_INCOME_STATUS_ID" />
                    <ForeignKeyLink dimension="Delivering as One"  foreignKeyColumn="OFFICIAL_REQUEST_DAO_COUNTRY"/>
                    <FactLink dimension="Date code of conduct was implemented" />
                    <ForeignKeyLink dimension="Does the UNCT have a code of conduct"  foreignKeyColumn="HAS_CODE_OF_CONDUCT"/>
                    <ForeignKeyLink dimension="Does UNDP have a Deputy Representative"  foreignKeyColumn="HASUNDPDEPUTY_REPRESENTATIVE"/>
                    <ForeignKeyLink dimension="Does the UNDP have a Country Director"  foreignKeyColumn="HAS_COUNTRY_DIRECTOR"/>
                    <ForeignKeyLink dimension="Is there a signed delegation of authority letter"  foreignKeyColumn="SIGNED_DELEGATION_AUTHORITY"/>                   
                    <ForeignKeyLink dimension="Is there a signed delegation of authority between the UNDP Resident Representative and the UNDP Country Director and/or UNDP Deputy Country Director?"  foreignKeyColumn="SIGNED_DELEGATION_OF_AUTHORITY_LETTER"/>
                </DimensionLinks>
            </MeasureGroup>
        </MeasureGroups>
    </Cube>
</Schema>
