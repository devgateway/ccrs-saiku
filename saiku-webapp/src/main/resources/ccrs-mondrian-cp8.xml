<Schema name="Joint Leadership and Management Profile" metamodelVersion="4.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="mondrian.xsd">
    <Annotations>
        <Annotation name="desc">Cube Schema for CCRS - Joint Leadership and Management Profile</Annotation>
    </Annotations>

    <PhysicalSchema>
        <!-- ## _SHARED_PHYSICAL_SCHEMA_TAG_ ## -->
        
        <!-- ## _YESNOTABLE_QUERIES_TAG_ ## -->

        <Query alias="CP8GeneralCube">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[
                        select
                            cp8.ID, cp8.DESIGNATION, cp8.ENTITY_YEAR,
                            COALESCE(COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as COUNTRY_INCOME_STATUS_ID,
                            COALESCE(SECONDARY_COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as SECONDARY_COUNTRY_INCOME_STATUS_ID,
                            CASE WHEN cp8.HASUNDPDEPUTY_REPRESENTATIVE = TRUE THEN 1 ELSE 0 END as HASUNDPDEPUTY_REPRESENTATIVE_COUNT,
                            CASE cp8.HASUNDPDEPUTY_REPRESENTATIVE WHEN TRUE THEN 1 WHEN FALSE THEN 0 ELSE -1 END as HASUNDPDEPUTY_REPRESENTATIVE,
                            CASE WHEN cp8.HAS_CODE_OF_CONDUCT = TRUE THEN 1 ELSE 0 END as HAS_CODE_OF_CONDUCT_COUNT,
                            CASE cp8.HAS_CODE_OF_CONDUCT WHEN TRUE THEN 1 WHEN FALSE THEN 0 ELSE -1 END as HAS_CODE_OF_CONDUCT,
                            date(cp8code.DATE_IMPLEMENTED) as DATE_IMPLEMENTED,
                            CASE WHEN cp8.HAS_COUNTRY_DIRECTOR = TRUE THEN 1 ELSE 0 END as HAS_COUNTRY_DIRECTOR_COUNT,                  
                            CASE cp8.HAS_COUNTRY_DIRECTOR WHEN TRUE THEN 1 WHEN FALSE THEN 0 ELSE -1 END as HAS_COUNTRY_DIRECTOR,
                            CASE WHEN cp8.SIGNED_DELEGATION_OF_AUTHORITY_LETTER = TRUE THEN 1 ELSE 0 END as SIGNED_DELEGATION_OF_AUTHORITY_LETTER_COUNT,
                            CASE cp8.SIGNED_DELEGATION_OF_AUTHORITY_LETTER WHEN TRUE THEN 1 WHEN FALSE THEN 0 ELSE -1 END as SIGNED_DELEGATION_OF_AUTHORITY_LETTER,
                            CASE WHEN cp8.SIGNED_DELEGATION_AUTHORITY = TRUE THEN 1 ELSE 0 END as SIGNED_DELEGATION_AUTHORITY_COUNT,
                            CASE cp8.SIGNED_DELEGATION_AUTHORITY WHEN TRUE THEN 1 WHEN FALSE THEN 0 ELSE -1 END as SIGNED_DELEGATION_AUTHORITY,
                            CASE cp1.OFFICIAL_REQUEST_DAO_COUNTRY WHEN TRUE THEN 1 WHEN FALSE THEN 0 ELSE -1 END as OFFICIAL_REQUEST_DAO_COUNTRY,
                            CASE WHEN cp8.has_sexual_exploitation_protection = TRUE THEN 1 ELSE 0 END as has_sexual_exploitation_protection_count,
                            CASE cp8.has_sexual_exploitation_protection WHEN TRUE THEN 1 WHEN FALSE THEN 0 ELSE -1 END as has_sexual_exploitation_protection_dim,
                            COALESCE(sexual_exploitation_protection_id.LABEL, 'X-CATEGORY') as sexual_exploitation_protection_id,
                            CASE WHEN cp8.has_agreeduncttor = TRUE THEN 1 ELSE 0 END as has_agreeduncttor_count,
                            CASE cp8.has_agreeduncttor WHEN TRUE THEN 1 WHEN FALSE THEN 0 ELSE -1 END as has_agreeduncttor_dim,
                            CASE WHEN cp8.has_agreed_conflict_resolution = TRUE THEN 1 ELSE 0 END as has_agreed_conflict_resolution_count,
                            CASE cp8.has_agreed_conflict_resolution WHEN TRUE THEN 1 WHEN FALSE THEN 0 ELSE -1 END as has_agreed_conflict_resolution_dim
                        from CP8JOINT_LEADERSHIP_MANAGEMENT cp8
                            JOIN CP1GENERAL_PROFILE cp1 ON cp8.DESIGNATION = cp1.DESIGNATION AND cp8.ENTITY_YEAR = cp1.ENTITY_YEAR
                            JOIN CP8CODE_OF_CONDUCT cp8code ON cp8code.PARENT_ID = cp8.ID
                            JOIN BASE_COUNTRY bc ON cp8.DESIGNATION = bc.iso2
                            JOIN v_cp_validated_designations v ON cp8.designation = v.designation and v.entity_year = cp8.ENTITY_YEAR
                            JOIN CATEGORY COUNTRY_INCOME_STATUS_ID on CP1.COUNTRY_INCOME_STATUS_ID=COUNTRY_INCOME_STATUS_ID.ID
                            LEFT JOIN CATEGORY SECONDARY_COUNTRY_INCOME_STATUS_ID on CP1.SECONDARY_COUNTRY_INCOME_STATUS_ID=SECONDARY_COUNTRY_INCOME_STATUS_ID.ID
                            LEFT JOIN CATEGORY sexual_exploitation_protection_id ON cp8.sexual_exploitation_protection_id=sexual_exploitation_protection_id.ID
                        WHERE cp8.DESIGNATION != 'AQ'
                          AND cp8.DESIGNATION != 'DOCO'
                    ]]>
                </SQL>
            </ExpressionView>
        </Query>
    </PhysicalSchema>
    
    <!--*************************************************************************
    ***** Shared Dimensions
    *************************************************************************-->
    <!-- ## _SHARED_DIMENSIONS_TAG_ ## -->

    <!--*************************************************************************
    ***** CP8 General Cube
    *************************************************************************-->
    <Cube name="Joint Leadership" caption="Joint Leadership and Management Profile" visible="true"
          cache="true" enabled="true" defaultMeasure="Count">
        <Dimensions>
            <Dimension source="Region" />
            <Dimension source="Country" />
            <Dimension source="Delivering as One" />
            <Dimension name="Year" caption="Year" table="CP8GeneralCube" visible="true">
                <Attributes>
                    <Attribute name="Year" keyColumn="ENTITY_YEAR" datatype="Integer" />
                </Attributes>
            </Dimension>
            <Dimension source="CATEGORY" table="CP8GeneralCube" name="COUNTRY_INCOME_STATUS_ID" caption="Country Income Status" />
            <Dimension source="CATEGORY" table="CP8GeneralCube" name="SECONDARY_COUNTRY_INCOME_STATUS_ID" caption="Secondary Country Income Status" />
            
            <Dimension table="YesNoTable" name="Does the UNCT have a code of conduct" caption="Does the UNCT have a code of conduct?" />

            <Dimension name="Date code of conduct was implemented" caption="Date code of conduct was implemented" table='CP8GeneralCube'
                       key="Dimension Id" type="TIME">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>

                    <Attribute name="Date" caption="Date" keyColumn="DATE_IMPLEMENTED"
                               hierarchyHasAll="true"
                               levelType="TimeUndefined" datatype="Date"/>
                </Attributes>
            </Dimension>

            <Dimension table="YesNoTable" name="Does the UNDP have a Country Director" caption="Does the UNDP have a Country Director?" />
            <Dimension table="YesNoTable" name="Is there a signed delegation of authority between the UNDP Resident Representative and the UNDP Country Director and/or UNDP Deputy Country Director?" caption="Is there a signed delegation of authority between the UNDP Resident Representative and the UNDP Country Director and/or UNDP Deputy Country Director?" />
            <Dimension table="YesNoTable" name="Does UNDP have a Deputy Representative" caption="Does UNDP have a Deputy Representative?" />
            <Dimension table="YesNoTable" name="Is there a signed delegation of authority letter" caption="Is there a signed delegation of authority letter between the UNDP Deputy Resident Representative (DR) and UNDP Country Director including for resource mobilization?" />
            <Dimension table="YesNoTable" name="hasSexualExploitationProtection" caption="Does the UNCT have an inter-agency taskforce, coordination mechanism or focal point on protection from sexual exploitation and abuse?" />
            <Dimension source="CATEGORY" table="CP8GeneralCube" name="sexual_exploitation_protection_id" caption="What kind of protection from sexual exploitation and abuse?" />
            <Dimension table="YesNoTable" name="hasAgreedUNCTTor" caption="Is there an agreed upon UNCT TOR?" />
            <Dimension table="YesNoTable" name="hasAgreedConflictResolution" caption="Is there an agreed Conflict Resolution Mechanism?" />
        </Dimensions>

        <MeasureGroups>
            <MeasureGroup name="CP8 General Cube Measures" table="CP8GeneralCube">
                <Measures>
                    <Measure name="Count" caption="Number of Country Records Submitted" column="ID" datatype="Integer"
                             aggregator="distinct-count" visible="true" formatString="#,###"/>

                    <Measure name="hasCodeOfConduct" caption="Count of 'Does the UNCT have a code of conduct?'" column="HAS_CODE_OF_CONDUCT_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasCountryDirector" caption="Count of 'Does the UNDP have a Country Director?'" column="HAS_COUNTRY_DIRECTOR_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="signedDelegationOfAuthorityLetter" caption="Count of 'Is there a signed delegation of authority between the UNDP Resident Representative and the UNDP Country Director and/or UNDP Deputy Country Director?'" column="SIGNED_DELEGATION_OF_AUTHORITY_LETTER_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasUNDPDeputyRepresentative" caption="Count of 'Does UNDP have a Deputy Representative?'" column="HASUNDPDEPUTY_REPRESENTATIVE_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>
                             
                    <Measure name="signedDelegationAuthority" caption="Count of 'Is there a signed delegation of authority letter between the UNDP Deputy Resident Representative (DR) and UNDP Country Director including for resource mobilization?'" column="SIGNED_DELEGATION_AUTHORITY_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasSexualExploitationProtection" caption="Count of 'Does the UNCT have an inter-agency taskforce, coordination mechanism or focal point on protection from sexual exploitation and abuse?'" column="has_sexual_exploitation_protection_count"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasAgreedUNCTTor" caption="Count of 'Is there an agreed upon UNCT TOR?'" column="has_agreeduncttor_count"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasAgreedConflictResolution" caption="Count of 'Is there an agreed Conflict Resolution Mechanism?'" column="has_agreed_conflict_resolution_count"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                </Measures>
                <DimensionLinks>
                    <!-- ## _SHARED_DIMENSIONS_LINKS_TAG_ ## -->
                    <FactLink dimension="COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="SECONDARY_COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="Date code of conduct was implemented" />
                    <ForeignKeyLink dimension="Does the UNCT have a code of conduct"  foreignKeyColumn="HAS_CODE_OF_CONDUCT"/>
                    <ForeignKeyLink dimension="Does UNDP have a Deputy Representative"  foreignKeyColumn="HASUNDPDEPUTY_REPRESENTATIVE"/>
                    <ForeignKeyLink dimension="Does the UNDP have a Country Director"  foreignKeyColumn="HAS_COUNTRY_DIRECTOR"/>
                    <ForeignKeyLink dimension="Is there a signed delegation of authority letter"  foreignKeyColumn="SIGNED_DELEGATION_AUTHORITY"/>                   
                    <ForeignKeyLink dimension="Is there a signed delegation of authority between the UNDP Resident Representative and the UNDP Country Director and/or UNDP Deputy Country Director?"  foreignKeyColumn="SIGNED_DELEGATION_OF_AUTHORITY_LETTER"/>
                    <ForeignKeyLink dimension="hasSexualExploitationProtection"  foreignKeyColumn="has_sexual_exploitation_protection_dim"/>
                    <FactLink dimension="sexual_exploitation_protection_id"/>
                    <ForeignKeyLink dimension="hasAgreedUNCTTor"  foreignKeyColumn="has_agreeduncttor_dim"/>
                    <ForeignKeyLink dimension="hasAgreedConflictResolution"  foreignKeyColumn="has_agreed_conflict_resolution_dim"/>
                </DimensionLinks>
            </MeasureGroup>
        </MeasureGroups>
    </Cube>
</Schema>
