<Schema name="Joint Funding and Financing Profile" metamodelVersion="4.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="mondrian.xsd">
    <Annotations>
        <Annotation name="desc">Cube Schema for CCRS - Joint Funding and Financing Profile</Annotation>
    </Annotations>

    <PhysicalSchema>
        <!-- ## _SHARED_PHYSICAL_SCHEMA_TAG_ ## -->
        
        <!-- ## _CATEGORY_QUERIES_TAG_ ## -->
        
        <!-- ## _YESNOTABLE_QUERIES_TAG_ ## -->
        
        <Query alias="CP7GeneralCube">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[
                        select
                            cp7.ID, cp7.DESIGNATION, cp7.ENTITY_YEAR, CP1.COUNTRY_INCOME_STATUS_ID, CP1.SECONDARY_COUNTRY_INCOME_STATUS_ID, cp7.OTHERUNCTJOINTLY_MANAGE_RESOURCES, 
                            CASE WHEN cp7.HAS_ONE_FUND_COUNTRY_LEVEL = TRUE THEN 1 ELSE 0 END as HAS_ONE_FUND_COUNTRY_LEVEL,
                            CASE WHEN cp7.HAS_ONE_FUND_COUNTRY_LEVEL = TRUE THEN CASE WHEN cp7onefund.ALLOCATION_CRITERIA_AGREED = TRUE THEN 1 ELSE 0 END ELSE null END as ALLOCATION_CRITERIA_AGREED,
                            CASE WHEN cp7.HASMTDFS = TRUE THEN 1 ELSE 0 END as HASMTDFS,
                            CASE WHEN cp7.GOV_HAS_INTEGRATED_NATIONAL_FINANCING_FRAMEWORK = TRUE THEN 1 ELSE 0 END as GOV_HAS_INTEGRATED_NATIONAL_FINANCING_FRAMEWORK,
                            CASE WHEN cp7.HAS_REVIEW_OF_FINANCING_LANDSCAPE = TRUE THEN 1 ELSE 0 END as HAS_REVIEW_OF_FINANCING_LANDSCAPE,
                            CASE WHEN cp7.GOV_HASSDGFINANCING_GAP_STRATEGY = TRUE THEN 1 ELSE 0 END as GOV_HASSDGFINANCING_GAP_STRATEGY,
                            CASE WHEN cp7.UNCT_HASSDGFINANCING_GAP_STRATEGY = TRUE THEN 1 ELSE 0 END as UNCT_HASSDGFINANCING_GAP_STRATEGY,
                            CASE WHEN cp7.UNCT_JOINTLY_MANAGE_RESOURCE_MOBILIZATION = TRUE THEN 1 ELSE 0 END as UNCT_JOINTLY_MANAGE_RESOURCE_MOBILIZATION,
                            CASE WHEN cp1.OFFICIAL_REQUEST_DAO_COUNTRY = TRUE THEN 1 ELSE 0 END as OFFICIAL_REQUEST_DAO_COUNTRY
                        from CP7JOINT_FUNDING_PROFILE cp7, CP1GENERAL_PROFILE cp1, CP7ONE_FUND_COUNTRY_LEVEL cp7onefund, BASE_COUNTRY bc, v_cp_validated_designations v
                        WHERE
                            cp7.DESIGNATION = cp1.DESIGNATION AND cp7.ENTITY_YEAR = cp1.ENTITY_YEAR AND
                            cp7onefund.PARENT_ID = cp7.id AND
                            cp7.DESIGNATION != 'AQ' AND cp7.DESIGNATION != 'DOCO' AND cp7.DESIGNATION = bc.iso2 and
                            cp7.designation = v.designation and v.entity_year = cp7.ENTITY_YEAR
                    ]]>
                </SQL>
            </ExpressionView>
        </Query>
    </PhysicalSchema>

    <!--*************************************************************************
    ***** Shared Dimensions
    *************************************************************************-->
    <!-- ## _SHARED_DIMENSIONS_TAG_ ## -->
    
    <!--*************************************************************************
    ***** CP7 General Cube
    *************************************************************************-->
    <Cube name="Joint Funding Profile" caption="Joint Funding Profile" visible="true"
          cache="true" enabled="true" defaultMeasure="Count">
        <Dimensions>
            <Dimension source="Region" />
            <Dimension source="Country" />
            <Dimension source="Delivering as One" />
            <Dimension name="Year" caption="Year" table="CP7GeneralCube" visible="true">
                <Attributes>
                    <Attribute name="Year" keyColumn="ENTITY_YEAR" datatype="Integer" />
                </Attributes>
            </Dimension>
            <Dimension source="CountryIncomeStatus" />
            <Dimension source="SecondaryCountryIncomeStatus" />

            <Dimension table="YesNoTable" name="Do you have a One Fund at the country level" caption="Do you have a One Fund at the country level?" />
            <Dimension table="YesNoTable" name="Were allocation criteria for the One Fund agreed upon by a joint UN-Government Steering Committee" caption="Were allocation criteria for the One Fund agreed upon by a joint UN-Government Steering Committee?" />
            <Dimension table="YesNoTable" name="Other than the One Fund, do you have any Multi-Donor Trust Funds (MDTFs)" caption="Other than the One Fund, do you have any Multi-Donor Trust Funds (MDTFs)?" />
            <Dimension table="YesNoTable" name="Partner government have an integrated national financing framework" caption="Does your partner government have an integrated national financing framework?" />
            <Dimension table="YesNoTable" name="Review of the full financing landscape" caption="Does it include a review of the full financing landscape?" />
            <Dimension table="YesNoTable" name="Partner government developed a strategy to close financing gap" caption="Has your partner government developed a strategy to close the SDG financing gap?" />
            <Dimension table="YesNoTable" name="UNCT strategy to close financing gap" caption="Has the UNCT developed a strategy to contribute to closing the SDG financing gap?" />
            <Dimension table="YesNoTable" name="Does the UNCT jointly manage resource mobilization" caption="Does the UNCT jointly manage resource mobilization?" />

            <Dimension name="Other UNCT resource mobilization" caption="Other UNCT resource mobilization" table="CP7GeneralCube" key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID"
                               hasHierarchy="false"
                               levelType="Regular" datatype="Integer"/>
                    <Attribute name="Other UNCT resource mobilization" caption="Other UNCT resource mobilization"
                               keyColumn="OTHERUNCTJOINTLY_MANAGE_RESOURCES" hierarchyAllMemberName="All Other UNCT resource mobilization"
                               hierarchyCaption="All Other UNCT resource mobilization" levelType="Regular"
                               datatype="String" />
                </Attributes>
           </Dimension>
        </Dimensions>

        <MeasureGroups>
            <MeasureGroup name="CP7 General Cube Measures" table="CP7GeneralCube">
                <Measures>
                    <Measure name="Count" caption="Number of Country Records Submitted" column="ID" datatype="Integer"
                             aggregator="distinct-count" visible="true" formatString="#,###"/>

                    <Measure name="hasOneFundCountryLevel" caption="Count of 'Do you have a One Fund at the country level?'" column="HAS_ONE_FUND_COUNTRY_LEVEL"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="allocationCriteriaAgreed" caption="Count of 'Were allocation criteria for the One Fund agreed upon by a joint UN-Government Steering Committee?'" column="ALLOCATION_CRITERIA_AGREED"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasMTDFs" caption="Count of 'Other than the One Fund, do you have any Multi-Donor Trust Funds (MDTFs)?'" column="HASMTDFS"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="partnerGovernmentHaveIntegratedNationalFinancingFramework" caption="Count of 'Does your partner government have an integrated national financing framework?'" column="GOV_HAS_INTEGRATED_NATIONAL_FINANCING_FRAMEWORK"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="includeReviewOfFinancingLandscape?" caption="Count of 'Does it include a review of the full financing landscape?'" column="HAS_REVIEW_OF_FINANCING_LANDSCAPE"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="strategyToCloseSdgFinancingGap" caption="Count of 'Has your partner government developed a strategy to close the SDG financing gap?'" column="GOV_HASSDGFINANCING_GAP_STRATEGY"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="hasUnctStrategyToCloseFinancingGap" caption="Count of 'Has the UNCT developed a strategy to contribute to closing the SDG financing gap?'" column="UNCT_HASSDGFINANCING_GAP_STRATEGY"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="doesUnctManageResourceMobilization" caption="Count of 'Does the UNCT jointly manage resource mobilization?'" column="UNCT_JOINTLY_MANAGE_RESOURCE_MOBILIZATION"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>
                </Measures>
                <DimensionLinks>
                    <!-- ## _SHARED_DIMENSIONS_LINKS_TAG_ ## -->
                    <ForeignKeyLink dimension="Do you have a One Fund at the country level"  foreignKeyColumn="HAS_ONE_FUND_COUNTRY_LEVEL"/>
                    <ForeignKeyLink dimension="Were allocation criteria for the One Fund agreed upon by a joint UN-Government Steering Committee"  foreignKeyColumn="ALLOCATION_CRITERIA_AGREED"/>
                    <ForeignKeyLink dimension="Other than the One Fund, do you have any Multi-Donor Trust Funds (MDTFs)"  foreignKeyColumn="HASMTDFS"/>
                    <ForeignKeyLink dimension="Partner government have an integrated national financing framework"  foreignKeyColumn="GOV_HAS_INTEGRATED_NATIONAL_FINANCING_FRAMEWORK"/>
                    <ForeignKeyLink dimension="Review of the full financing landscape"  foreignKeyColumn="HAS_REVIEW_OF_FINANCING_LANDSCAPE"/>
                    <ForeignKeyLink dimension="Partner government developed a strategy to close financing gap"  foreignKeyColumn="GOV_HASSDGFINANCING_GAP_STRATEGY"/>
                    <ForeignKeyLink dimension="UNCT strategy to close financing gap"  foreignKeyColumn="UNCT_HASSDGFINANCING_GAP_STRATEGY"/>
                    <ForeignKeyLink dimension="Does the UNCT jointly manage resource mobilization"  foreignKeyColumn="UNCT_JOINTLY_MANAGE_RESOURCE_MOBILIZATION"/>
                    <ForeignKeyLink dimension="Other UNCT resource mobilization"  foreignKeyColumn="OTHERUNCTJOINTLY_MANAGE_RESOURCES"/>
                </DimensionLinks>
            </MeasureGroup>
        </MeasureGroups>
    </Cube>
</Schema>
