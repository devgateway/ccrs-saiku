<Schema name="Shared Operational Support (Common Back Office Functions)" metamodelVersion="4.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="mondrian.xsd">
    <Annotations>
        <Annotation name="desc">Cube Schema for CCRS - Shared Operational Support (Common Back Office Functions)</Annotation>
    </Annotations>

    <PhysicalSchema>
        <!-- ## _SHARED_PHYSICAL_SCHEMA_TAG_ ## -->
        
		<Query alias="ClientSatisfactionScore">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[SELECT ID, LABEL || ' - Average client satisfaction score of the Integrated Service Center' as LABEL FROM CATEGORY WHERE DTYPE='ClientSatisfactionScore']]>
                </SQL>
            </ExpressionView>
        </Query>

        <Query alias="CP4GeneralCube">
            <ExpressionView>
                <SQL dialect="generic">
                    <![CDATA[
                        select
                            cp4.ID, cp4.DESIGNATION, cp4.ENTITY_YEAR,
                            COALESCE(COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as COUNTRY_INCOME_STATUS_ID,
                            COALESCE(SECONDARY_COUNTRY_INCOME_STATUS_ID.LABEL, 'X-CATEGORY') as SECONDARY_COUNTRY_INCOME_STATUS_ID,
                            CASE WHEN cp4.COUNTRY_LEVELHACT = TRUE THEN 1 ELSE 0 END as COUNTRY_LEVELHACT_COUNT,
                            COALESCE(cp4.COUNTRY_LEVELHACT, 'X-BOOLEAN') AS COUNTRY_LEVELHACT,
                            COALESCE(cp1.OFFICIAL_REQUEST_DAO_COUNTRY, 'X-BOOLEAN') AS OFFICIAL_REQUEST_DAO_COUNTRY,
                            CASE WHEN CP4.INTEGRATED_SERVICE_CENTER_AVAILABLE = TRUE THEN 1 ELSE 0 END as INTEGRATED_SERVICE_CENTER_AVAILABLE_COUNT,
                            COALESCE(CP4.INTEGRATED_SERVICE_CENTER_AVAILABLE, 'X-BOOLEAN') AS INTEGRATED_SERVICE_CENTER_AVAILABLE,
                            CASE WHEN CP4.HASBOSCOMMON_SERVICE_LINES = TRUE THEN 1 ELSE 0 END as HASBOSCOMMON_SERVICE_LINES_COUNT,
                            COALESCE(CP4.HASBOSCOMMON_SERVICE_LINES, 'X-BOOLEAN') AS HASBOSCOMMON_SERVICE_LINES,
                            COALESCE(HOST_ID.LABEL, 'X-CATEGORY') as HOST_ID,
							cp4integratedservicecenter.BUDGET,
							COALESCE(cp4integratedservicecenter.CLIENT_SATISFACTION_SCORE_ID, -1) AS CLIENT_SATISFACTION_SCORE_ID,
							CASE WHEN CP4.jointhact = TRUE THEN 1 ELSE 0 END as jointhact_count,
                            COALESCE(CP4.jointhact, 'X-BOOLEAN') AS jointhact_dim,
                            CASE WHEN CP4.joint_macro_assessment = TRUE THEN 1 ELSE 0 END as joint_macro_assessment_count,
                            COALESCE(CP4.joint_macro_assessment, 'X-BOOLEAN') AS joint_macro_assessment_dim,
                            CASE WHEN CP4.joint_micro_assessment = TRUE THEN 1 ELSE 0 END as joint_micro_assessment_count,
                            COALESCE(CP4.joint_micro_assessment, 'X-BOOLEAN') AS joint_micro_assessment_dim,
                            CASE WHEN CP4.joint_assurance_activities = TRUE THEN 1 ELSE 0 END as joint_assurance_activities_count,
                            COALESCE(CP4.joint_assurance_activities, 'X-BOOLEAN') AS joint_assurance_activities_dim
                        FROM CP4COMMON_SERVICES_HARMONIZED_BUSINES_PRACTICES cp4
                            JOIN CP1GENERAL_PROFILE cp1 ON cp4.DESIGNATION = cp1.DESIGNATION AND cp4.ENTITY_YEAR = cp1.ENTITY_YEAR
                            JOIN BASE_COUNTRY bc ON cp4.DESIGNATION = bc.iso2
                            JOIN v_cp_validated_designations v ON cp4.designation = v.designation and v.entity_year = cp4.ENTITY_YEAR
                            JOIN CP4INTEGRATED_SERVICE_CENTER cp4integratedservicecenter ON cp4integratedservicecenter.PARENT_ID = CP4.ID
                            JOIN CATEGORY COUNTRY_INCOME_STATUS_ID on CP1.COUNTRY_INCOME_STATUS_ID=COUNTRY_INCOME_STATUS_ID.ID
                            LEFT JOIN CATEGORY SECONDARY_COUNTRY_INCOME_STATUS_ID on CP1.SECONDARY_COUNTRY_INCOME_STATUS_ID=SECONDARY_COUNTRY_INCOME_STATUS_ID.ID
                            LEFT JOIN CATEGORY HOST_ID ON cp4integratedservicecenter.HOST_ID=HOST_ID.ID
                        WHERE cp4.DESIGNATION != 'AQ'
                          AND cp4.DESIGNATION != 'DOCO'
                    ]]>
                </SQL>
            </ExpressionView>
        </Query>
    </PhysicalSchema>
    <!--*************************************************************************
    ***** Shared Dimensions
    *************************************************************************-->
    <!-- ## _SHARED_DIMENSIONS_TAG_ ## -->

    <!--*************************************************************************
    ***** CP4 General Cube
    *************************************************************************-->
    <Cube name="Common Services" caption="Business Operations Strategy and Common Back Office Functions" visible="true"
          cache="true" enabled="true" defaultMeasure="Count">
        <Dimensions>
            <Dimension source="Region" />
            <Dimension source="Country" />
            <Dimension source="YesNoTable" table="CP4GeneralCube" name="OFFICIAL_REQUEST_DAO_COUNTRY" caption="Delivering as One" />
            <Dimension name="Year" caption="Year" table="CP4GeneralCube" visible="true">
                <Attributes>
                    <Attribute name="Year" keyColumn="ENTITY_YEAR" datatype="Integer" />
                </Attributes>
            </Dimension>
            <Dimension source="CATEGORY" table="CP4GeneralCube" name="COUNTRY_INCOME_STATUS_ID" caption="Country Income Status" />
            <Dimension source="CATEGORY" table="CP4GeneralCube" name="SECONDARY_COUNTRY_INCOME_STATUS_ID" caption="Secondary Country Income Status" />
            
            <Dimension source="YesNoTable" table="CP4GeneralCube" name="COUNTRY_LEVELHACT" caption="Is a HACT being implemented at the country level?" />
            <Dimension source="YesNoTable" table="CP4GeneralCube" name="INTEGRATED_SERVICE_CENTER_AVAILABLE" caption="Does the UNCT have a Common Back Office/Integrated Service Center in place to deliver some or all of the services under the BOS?" />
            <Dimension source="CATEGORY" table="CP4GeneralCube" name="HOST_ID" caption="Which UN entity currently hosts the Common Back Office/Integrated service center?" />
            <Dimension name="clientSatisfactionScore" caption="What is the average client satisfaction score of the Common Back Office/Integrated Service Center?" table="ClientSatisfactionScore"
                       key="Dimension Id" visible="true">
                <Attributes>
                    <Attribute name="Dimension Id" keyColumn="ID" hasHierarchy="false"
                               levelType="Regular" datatype="Integer" />

                    <Attribute name="clientSatisfactionScore" caption="What is the average client satisfaction score of the Common Back Office/Integrated Service Center?" keyColumn="LABEL"
                               hierarchyAllMemberName="All " hierarchyCaption=""
                               levelType="Regular" datatype="String" />
                </Attributes>
            </Dimension>
            <Dimension source="YesNoTable" table="CP4GeneralCube" name="HASBOSCOMMON_SERVICE_LINES" caption="Does the UNCT have a Business Operations Strategy (BOS)?" />
            <Dimension source="YesNoTable" table="CP4GeneralCube" name="jointhact_dim" caption="Has the HACT being implemented jointly across the UNCT?" />
            <Dimension source="YesNoTable" table="CP4GeneralCube" name="joint_macro_assessment_dim" caption="Has the macro assessment being executed jointly?" />
            <Dimension source="YesNoTable" table="CP4GeneralCube" name="joint_micro_assessment_dim" caption="Is one or more of the micro assessment being executed jointly?" />
            <Dimension source="YesNoTable" table="CP4GeneralCube" name="joint_assurance_activities_dim" caption="Are the assurance activities being executed jointly?" />
        </Dimensions>

        <MeasureGroups>
            <MeasureGroup name="CP4 General Cube Measures" table="CP4GeneralCube">
                <Measures>
                    <Measure name="Count" caption="Number of Country Records Submitted" column="ID" datatype="Integer"
                             aggregator="distinct-count" visible="true" formatString="#,###"/>

                    <Measure name="countryLevelHACT" caption="Count of 'Is a HACT being implemented at the country level?'" column="COUNTRY_LEVELHACT_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="UnctHaveIntegratedServiceCenter" caption="Count of 'Does the UNCT have a Common Back Office/Integrated Service Center in place to deliver some or all of the services under the BOS?'" column="INTEGRATED_SERVICE_CENTER_AVAILABLE_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="Budget" caption="Annual budget of the Common Back Office/Integrated Service Center in US dollars" column="BUDGET"
                             datatype="Numeric" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="CommonServiceLinesPartOfBos" caption="Count of 'Does the UNCT have a Business Operations Strategy (BOS)?'" column="HASBOSCOMMON_SERVICE_LINES_COUNT"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="jointHACT" caption="Count of 'Has the HACT being implemented jointly across the UNCT?'" column="jointhact_count"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="jointMacroAssessment" caption="Count of 'Has the macro assessment being executed jointly?'" column="joint_macro_assessment_count"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="jointMicroAssessment" caption="Count of 'Is one or more of the micro assessment being executed jointly?'" column="joint_micro_assessment_count"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>

                    <Measure name="jointAssuranceActivities" caption="Count of 'Are the assurance activities being executed jointly?'" column="joint_assurance_activities_count"
                             datatype="Integer" aggregator="sum" visible="true" formatString="#,###"/>
                </Measures>
                <DimensionLinks>
                    <!-- ## _SHARED_DIMENSIONS_LINKS_TAG_ ## -->
                    <FactLink dimension="OFFICIAL_REQUEST_DAO_COUNTRY" />
                    <FactLink dimension="COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="SECONDARY_COUNTRY_INCOME_STATUS_ID" />
                    <FactLink dimension="COUNTRY_LEVELHACT" />
                    <FactLink dimension="INTEGRATED_SERVICE_CENTER_AVAILABLE" />
                    <FactLink dimension="HOST_ID"/>
                    <ForeignKeyLink dimension="clientSatisfactionScore"  foreignKeyColumn="CLIENT_SATISFACTION_SCORE_ID"/>
                    <FactLink dimension="HASBOSCOMMON_SERVICE_LINES" />
                    <FactLink dimension="jointhact_dim" />
                    <FactLink dimension="joint_macro_assessment_dim" />
                    <FactLink dimension="joint_micro_assessment_dim" />
                    <FactLink dimension="joint_assurance_activities_dim" />
                </DimensionLinks>
            </MeasureGroup>
        </MeasureGroups>
    </Cube>
</Schema>
